#!/bin/sh
trap ''  1 2 3 7 13 15
. /etc/bowerbird/config/global_variables
exec >>$log_dir/ppp_daemon 2>&1
set -x

ps -ef|grep 'ppp_daemon$'|sed "/$$/d;/grep/d;s/^[a-z]* *//;s/ .*//"|xargs -r kill -9
unsuccessful_power_cycles=0
while test $unsuccessful_power_cycles -lt 10
do
	set_power on $sw_nextg
	modprobe ppp_generic
	modprobe ppp_async
	modprobe ppp_deflate
	modprobe ppp_synctty
	modprobe bsd_comp
	sleep 30
	modprobe option
	failures=0
	while test $failures -lt 30
	do
		sleep_seconds=1
		while test $sleep_seconds -gt 0
		do
			if ppp_up
			then
				touch $network_alive_file
				ping_count=60
				while test $ping_count -gt 0
				do
					echo 'i:down' >$status_dir/ppp.message
					if ping -c 1 -q 129.94.172.235 || ping -c 1 -q 203.2.75.132 || ping -c 1 -q 61.9.211.33
					then
						sleep 60
						ping_count=`expr $ping_count - 1`
					else
						echo 'i:down' >$status_dir/ppp.message
						message 'ping failed'
					fi
				done
				sleep_seconds=100
			else
				echo 'i:down' >$status_dir/ppp.message
				message 'internet not connected'
				sleep_seconds=`expr $sleep_seconds / 10`
			fi
			sleep $sleep_seconds
		done
		message 'restarting ppp'
		ps -ef|grep 'pppd'|sed "/$$/d;/grep/d;s/^[a-z]* *//;s/ .*//"|xargs -r kill -9
#		message "signal strength: `sed 5q </dev/ttyUSB1|grep CSQ:|sed 's/,.*//;s/.* //' & echo AT+CSQ >/dev/ttyUSB1`"  &
#		sleep 10

		if pppd defaultroute  updetach debug persist holdoff 60 call $ppp_name && ppp_up
		then
			message 'ppp running'
			echo 'i:up' >$status_dir/ppp.message
			failures=0
			unsuccessful_power_cycles=0
			ssh -R 11122:$ip:22 -R 11123:$ip:23 -N -n $remote_account &
			ssh $remote_account ./execute_software_update
			ssh $remote_account ./local_software_update|sh -x
			message "connected to' $remote_account"
			sleep 7200
		else
			message 'ppp not running'
			echo 'i:down' >$status_dir/ppp.message
			failures=$((failures + 1))
			sleep 5
		fi
	done
	unsuccessful_power_cycles=$((unsuccessful_power_cycles + 1))
	# usb_hub becomes inaccessible if no device on
	set_power on $sw_disk
	set_power off $sw_nextg
	modprobe -r ppp_generic
	modprobe -r ppp_async
	modprobe -r ppp_deflate
	modprobe -r ppp_synctty
	modprobe -r bsd_comp
	modprobe -r option
	sleep 5
done
message 'rebooting in 1hr to fix nextg'
sleep 3600
message 'rebooting to fix nextg'
do_reboot
